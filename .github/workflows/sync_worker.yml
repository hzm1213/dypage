name: Sync _worker.js from upstream

on:
  schedule:
    - cron: '0 1 * * *'  # æ¯å¤© UTC 17 ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ 1 AMï¼‰
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout current repo
        uses: actions/checkout@v4

      - name: Fetch upstream file
        run: |
          curl -sL "https://raw.githubusercontent.com/yonggekkk/Cloudflare-vless-trojan/main/Vless_workers_pages/vlessæ— éœ€proxyipçš„nat64å¥—å£³ç‰ˆ%20(æŽ¨èä½¿ç”¨).js" -o new_worker.js

      - name: Compare with existing _worker.js
        id: compare
        run: |
          if [ ! -f _worker.js ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          elif ! cmp -s new_worker.js _worker.js; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Replace _worker.js and update wrangler.toml if changed
        if: steps.compare.outputs.changed == 'true'
        run: |
          mv new_worker.js _worker.js
          TODAY=$(date +%F)
          if [ -f wrangler.toml ]; then
            sed -i "s/^compatibility_date = \".*\"/compatibility_date = \"$TODAY\"/" wrangler.toml
          else
            echo "name = \"dypage\"" > wrangler.toml
            echo "main = \"_worker.js\"" >> wrangler.toml
            echo "compatibility_date = \"$TODAY\"" >> wrangler.toml
            echo "keep_vars = true" >> wrangler.toml
          fi

      - name: Commit and push if changed
        if: steps.compare.outputs.changed == 'true'
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add _worker.js wrangler.toml
          git commit -m "ðŸ”„ Update _worker.js and wrangler.toml compatibility_date to $TODAY"
          git push
